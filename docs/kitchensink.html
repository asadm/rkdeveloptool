<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>rkdeveloptool WebUSB demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 2rem auto; }
    button { padding: 0.6rem 1rem; font-size: 1rem; }
    pre { background: #f4f4f4; padding: 1rem; min-height: 4rem; }
  </style>
</head>
<body>
  <h1>rkdeveloptool WebUSB demo</h1>
  <p>Click “Grant USB access” to authorize, then “List devices” to view Rockchip devices. Use “Download boot” to send a loader (.bin) to a maskrom device, or “Write LBA” to flash a file starting at a specific sector (requires loader/maskrom mode).</p>
  <button id="request-btn">Grant USB access</button>
  <button id="list-btn">List devices</button>
  <input type="file" id="loader-file" accept=".bin" />
  <button id="download-btn">Download boot</button>
  <div style="margin-top:0.5rem;">
    <label for="wl-begin">Begin LBA:</label>
    <input type="number" id="wl-begin" min="0" step="1" value="0" style="width:8rem;">
    <input type="file" id="wl-file" />
    <button id="write-btn">Write LBA</button>
  </div>
  <button id="test-btn">Test device</button>
  <div style="margin-top:0.5rem;">
    <label for="reset-subcode">Reset subcode:</label>
    <input type="number" id="reset-subcode" min="0" max="255" step="1" value="0" style="width:6rem;">
    <button id="reset-btn">Reset device</button>
  </div>
  <button id="rid-btn">Read Flash ID</button>
  <button id="rfi-btn">Read Flash Info</button>
  <button id="rci-btn">Read Chip Info</button>
  <button id="rcb-btn">Read Capability</button>
  <button id="ppt-btn">Print partitions</button>
  <button id="erase-btn" style="color:red;">Erase flash (DANGER)</button>
  <pre id="output">Waiting…</pre>

  <script type="module">
    import createModule from './rkDevelopTool_Mac.js'; // Generated by Emscripten with -sMODULARIZE=1 -sEXPORT_NAME=createModule

    const output = document.getElementById('output');
    const modulePromise = createModule({
      noInitialRun: true,
      locateFile: (path) => {
        if (path.endsWith('.wasm')) return './rkDevelopTool_Mac.wasm';
        return path;
      }
    });

    document.getElementById('reset-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const subInput = document.getElementById('reset-subcode');
        const sub = parseInt(subInput.value, 10);
        if (!Number.isFinite(sub) || sub < 0 || sub > 255) {
          log('Enter a reset subcode between 0 and 255.');
          return;
        }
        const ok = await Module.resetDevice(sub);
        log(ok ? `ResetDevice (subcode ${sub}) sent.` : 'ResetDevice failed.');
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    const log = (msg) => {
      output.textContent = msg;
      console.log(msg);
    };

    async function readFileAsUint8Array(file) {
      const buf = await file.arrayBuffer();
      return new Uint8Array(buf);
    }

    document.getElementById('request-btn').addEventListener('click', async () => {
      try {
        await navigator.usb.requestDevice({
          filters: [{ vendorId: 0x2207 }, { vendorId: 0x071B }]
        });
        log('Permission granted (or already granted). Now click "List devices".');
      } catch (err) {
        console.error(err);
        log(`Permission denied or error: ${err.message || err}`);
      }
    });

    document.getElementById('list-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const allowed = await navigator.usb.getDevices();
        console.log('Allowed WebUSB devices:', allowed.map(d => ({
          vid: `0x${d.vendorId.toString(16)}`,
          pid: `0x${d.productId.toString(16)}`,
          product: d.productName
        })));

        const raw = await Module.listDevicesJs();
        const devices = Array.from(raw || []);
        console.log('listDevicesJs raw result:', raw, 'mapped length:', devices.length);
        if (!devices || devices.length === 0) {
          log('No Rockchip devices found (make sure permission was granted).');
          return;
        }
        const lines = devices.map(
          (d) => `DevNo=${d.devNo} Vid=0x${d.vid.toString(16)} Pid=0x${d.pid.toString(16)} LocationID=${d.locationId} ${d.type}`
        );
        log(lines.join('\n'));
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('download-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const fileInput = document.getElementById('loader-file');
        if (!fileInput.files || fileInput.files.length === 0) {
          log('Select a loader .bin file first.');
          return;
        }
        const file = fileInput.files[0];
        const data = await readFileAsUint8Array(file);

        log(`Downloading bootloader (${file.name})…`);
        const ok = await Module.downloadBootBuffer(data);

        log(ok ? 'Downloading bootloader succeeded.' : 'Downloading bootloader failed.');
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('write-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const beginInput = document.getElementById('wl-begin');
        const begin = parseInt(beginInput.value, 10);
        if (!Number.isFinite(begin) || begin < 0) {
          log('Enter a valid begin sector (>=0).');
          return;
        }
        const fileInput = document.getElementById('wl-file');
        if (!fileInput.files || fileInput.files.length === 0) {
          log('Select an image file to flash.');
          return;
        }
        const file = fileInput.files[0];
        const data = await readFileAsUint8Array(file);

        log(`Writing ${file.name} (${data.byteLength} bytes) starting at LBA ${begin}…`);
        const ok = await Module.writeLba(begin, data);
        log(ok ? 'WriteLBA complete.' : 'WriteLBA failed (check that the device is in loader/maskrom mode).');
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('test-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const ok = await Module.testDevice();
        log(ok ? 'TestDevice succeeded.' : 'TestDevice failed.');
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('rid-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const id = await Module.readFlashId();
        console.log('readFlashId result:', id);
        if (!id || typeof id.length === 'undefined' || id.length === 0) {
          log('ReadFlashID failed (likely requires loader mode).');
          return;
        }
        log(`Flash ID: ${Array.from(id).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('rfi-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const info = await Module.readFlashInfo();
        console.log('readFlashInfo result:', info);
        if (!info || info.manufacturer === undefined) {
          log('ReadFlashInfo failed (likely requires loader mode).');
          return;
        }
        log(`FlashInfo: manufacturer=${info.manufacturer}, size=${info.flashSizeMiB}MiB, block=${info.blockSize}, page=${info.pageSize}, blocks=${info.blockCount}, eccBits=${info.eccBits}, accessTime=${info.accessTime}, flashCs=${info.flashCs}, validSecPerBlock=${info.validSectorsPerBlock}`);
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('rci-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const chip = await Module.readChipInfo();
        console.log('readChipInfo result:', chip);
        if (!chip || typeof chip.length === 'undefined' || chip.length === 0) {
          log('ReadChipInfo failed (likely requires loader mode).');
          return;
        }
        log(`ChipInfo: ${Array.from(chip).map(b => b.toString(16).padStart(2, '0')).join(' ')}`);
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('rcb-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const cap = await Module.readCapability();
        console.log('readCapability result:', cap);
        if (!cap) {
          log('ReadCapability failed.');
          return;
        }
        if (cap.rawFlag === undefined) {
          log('ReadCapability returned empty result (likely requires loader mode).');
          return;
        }
        log(`Capability: directLba=${cap.directLba} first4mAccess=${cap.first4mAccess} rawFlag=0x${cap.rawFlag.toString(16)}`);
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('ppt-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const parts = await Module.printPartitions();
        console.log('printPartitions result:', parts);
        if (!parts || !parts.length) {
          log('PrintPartition failed (likely requires loader mode).');
          return;
        }
        const lines = parts.map((p) => `#${p.index} LBA=${p.startLba} ${p.name}`);
        log(lines.join('\n'));
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });

    document.getElementById('erase-btn').addEventListener('click', async () => {
      const confirmErase = window.confirm('This will ERASE the entire flash. Are you sure?');
      if (!confirmErase) return;
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const ok = await Module.eraseFlash();
        log(ok ? 'Erase flash complete.' : 'Erase flash failed.');
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });
  </script>
</body>
</html>
