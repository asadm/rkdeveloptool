<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>rkdeveloptool WebUSB demo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 2rem auto; }
    button { padding: 0.6rem 1rem; font-size: 1rem; }
    pre { background: #f4f4f4; padding: 1rem; min-height: 4rem; }
  </style>
</head>
<body>
  <h1>rkdeveloptool WebUSB demo</h1>
  <p>Click “List devices” to enumerate Rockchip USB devices (requires user gesture and a WebUSB-enabled browser).</p>
  <button id="request-btn">Grant USB access</button>
  <button id="list-btn">List devices</button>
  <pre id="output">Waiting…</pre>

  <script type="module">
    import createModule from './rkDevelopTool_Mac.js'; // Generated by Emscripten with -sMODULARIZE=1 -sEXPORT_NAME=createModule

    const output = document.getElementById('output');
    const modulePromise = createModule({
      noInitialRun: true,
      locateFile: (path) => {
        if (path.endsWith('.wasm')) return './rkDevelopTool_Mac.wasm';
        return path;
      }
    });

    const log = (msg) => {
      output.textContent = msg;
      console.log(msg);
    };

    document.getElementById('request-btn').addEventListener('click', async () => {
      try {
        await navigator.usb.requestDevice({
          filters: [{ vendorId: 0x2207 }, { vendorId: 0x071B }]
        });
        log('Permission granted (or already granted). Now click "List devices".');
      } catch (err) {
        console.error(err);
        log(`Permission denied or error: ${err.message || err}`);
      }
    });

    document.getElementById('list-btn').addEventListener('click', async () => {
      log('Loading WASM…');
      const Module = await modulePromise;
      try {
        const allowed = await navigator.usb.getDevices();
        console.log('Allowed WebUSB devices:', allowed.map(d => ({
          vid: `0x${d.vendorId.toString(16)}`,
          pid: `0x${d.productId.toString(16)}`,
          product: d.productName
        })));

        const raw = await Module.listDevicesJs();
        const devices = Array.from(raw || []);
        console.log('listDevicesJs raw result:', raw, 'mapped length:', devices.length);
        if (!devices || devices.length === 0) {
          log('No Rockchip devices found (make sure permission was granted).');
          return;
        }
        const lines = devices.map(
          (d) => `DevNo=${d.devNo} Vid=0x${d.vid.toString(16)} Pid=0x${d.pid.toString(16)} LocationID=${d.locationId} ${d.type}`
        );
        log(lines.join('\n'));
      } catch (err) {
        console.error(err);
        log(`Error: ${err}`);
      }
    });
  </script>
</body>
</html>
